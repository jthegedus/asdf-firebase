#!/usr/bin/env bash

set -euo pipefail

current_script_path="${BASH_SOURCE[0]}"
plugin_dir="$(dirname "$(dirname "$current_script_path")")"

# shellcheck source=../lib/envs.bash
source "${plugin_dir}/lib/envs.bash"

function fail() {
	printf "* ERROR: asdf-%s %s\\n" "$TOOL_NAME" "$*"
	exit 1
}

function get_os_name() {
	local os_name
	case $(uname -s) in
	Linux*)
		os_name="linux"
		;;
	Darwin*)
		os_name="macos"
		;;
	*)
		fail "Script only supports macOS and Ubuntu"
		;;
	esac
	printf "%s\\n" "${os_name}"
}

function download() {
	local url
	url="${GH_REPO}/releases/download/v${ASDF_INSTALL_VERSION}/firebase-tools-$(get_os_name)"

	printf "%s\\n" "* downloading ${TOOL_NAME} ${ASDF_INSTALL_VERSION} from ${url}"
	status_code=$(curl -X GET \
		--write-out "%{http_code}" \
		--progress-bar \
		-Lo "${ASDF_DOWNLOAD_PATH}/${TOOL_NAME}" \
		"${url}")

	if [[ ${status_code} -eq 404 ]]; then
		rm -rf "${ASDF_DOWNLOAD_PATH}"
		fail "An error occurred. firebase-tools may not have been found for version ${ASDF_INSTALL_VERSION}. Full versions are required, not just major version numbers."
	fi
	printf "%s\\n" "* Downloaded to ${ASDF_DOWNLOAD_PATH}/${TOOL_NAME}"
}

download
