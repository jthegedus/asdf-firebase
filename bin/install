#!/usr/bin/env bash

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

# shellcheck source=../lib/envs.bash
. "${plugin_dir}/lib/envs.bash"

function fail() {
	printf "* ERROR: asdf-%s %s\\n" "$TOOL_NAME" "$*"
	exit 1
}

# ref installs not supported
if [ "$ASDF_INSTALL_TYPE" != "version" ]; then
	fail "supports release installs only. See \"asdf list all $TOOL_NAME\" for a list of supported versions."
fi

if [ "$ASDF_INSTALL_TYPE" == "version" ]; then
	# validate version(non-ref) is in list-all versions
	results="$(asdf list all v)"
	if ! grep -q "^$ASDF_INSTALL_VERSION$" <<<"$results"; then
		fail "version \"$ASDF_INSTALL_VERSION\" not supported. \"asdf list all $TOOL_NAME\" will list available versions."
	fi

	# Warn if user attempts to install a version(non-ref) that the plugin might not support
	if awk "BEGIN {exit !($ASDF_INSTALL_VERSION < $MIN_SUPPORTED_VERSION)}"; then
		printf "* WARNING asdf-%s was developed for versions \"%s\" and later.\\n" "$TOOL_NAME" "$MIN_SUPPORTED_VERSION"
		printf "          Versions before this are not guaranteed to work.\\n"
	fi
fi

# download & install
(
	printf "* Downloading %s@%s\\n" "$TOOL_NAME" "$ASDF_INSTALL_VERSION"
	# if not asdf version with asdf_download_path then call download script here
	if [ -z "${ASDF_DOWNLOAD_PATH:-}" ]; then
		tmp_download_dir=$(mktemp -d -t 'asdf_firebase_XXXXXX')
		trap 'rm -rf "${tmp_download_dir}"' EXIT
		printf "* run download script for older version of asdf"
		export ASDF_DOWNLOAD_PATH="${tmp_download_dir}"

		# download
		bash "$(dirname "$0")/download"
	fi

	mkdir -p "${ASDF_INSTALL_PATH}/bin"
	cp "${ASDF_DOWNLOAD_PATH}/firebase" "${ASDF_INSTALL_PATH}/bin"
	printf "* Moved to %s\\n" "$ASDF_INSTALL_PATH"
	chmod +rx "${ASDF_INSTALL_PATH}/bin/firebase"

	printf "* Testing if %s@%s is executable\\n" "$TOOL_NAME" "$ASDF_INSTALL_VERSION"
	tool_cmd="$(printf "%s\\n" "$TOOL_TEST" | cut -d' ' -f1)"
	test -x "$ASDF_INSTALL_PATH/bin/$tool_cmd" || fail "Expected $ASDF_INSTALL_PATH/bin/$tool_cmd to be executable."
	printf "* Success! %s@%s is ready for use.\\n" "$TOOL_NAME" "$ASDF_INSTALL_VERSION"
) || (
	rm -rf "$ASDF_INSTALL_PATH"
	fail "An error ocurred while installing $TOOL_NAME@$ASDF_INSTALL_VERSION"
)
